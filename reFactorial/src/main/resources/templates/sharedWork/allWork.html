<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!--폰트 적용-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/style.css}">
    <link rel="stylesheet" th:href="@{/css/sharedWork/sharedWork.css}">
</head>
<body>

<header th:replace="~{/common/header::headerFragment}"></header>
<section>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-title">업무공유</div>
            <ul>
                <li onclick="location.href='sharedWork/allWork'">전체업무</li>
                <li>업무공유</li>
            </ul>
        </div>

        <!-- 메인 폼 -->
        <div class="main-content">
            <!-- 캘린더 출력 -->
            <div id='calendar'></div>

            <!-- 모달 팝업 -->
            <div class="modal-overlay" id="modal-overlay"></div>
            <div class="modal" id="modal">
                <h2>일정 공유</h2>
                <label for="eventTitle">제목:</label>
                <input type="text" id="eventTitle" placeholder="일정 제목을 입력하세요">
                <label for="eventDescription">설명:</label>
                <textarea id="eventDescription" placeholder="일정 설명을 입력하세요"></textarea>
                <label for="eventStartDate">시작 날짜</label>
                <input type="date" id="eventStartDate">
                <label for="eventEndDate">종료 날짜</label>
                <input type="date" id="eventEndDate">

                <button id="saveEventBtn">저장</button>
                <button id="deleteEventBtn">삭제</button>
                <button id="closeModalBtn">닫기</button>
            </div>
        </div>
    </div>
</section>

<footer th:replace="~{/common/footer::footerFragment}"></footer>

<!-- 캘린더 스크립트 -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var modal = document.getElementById('modal');
        var modalOverlay = document.getElementById('modal-overlay');
        var closeModalBtn = document.getElementById('closeModalBtn');
        var saveEventBtn = document.getElementById('saveEventBtn');
        var deleteEventBtn = document.getElementById('deleteEventBtn');
        var eventTitleInput = document.getElementById('eventTitle');
        var eventDescriptionInput = document.getElementById('eventDescription');
        var eventStartDateInput = document.getElementById('eventStartDate');
        var eventEndDateInput = document.getElementById('eventEndDate');


        // 부서별 색상 설정 (dept_code와 매핑)
        var departmentColors = {
            1: '#FF5733', // 인사팀 (주황색)
            2: '#33FF57', // 개발팀 (초록색)
            3: '#FF33A1', // 마케팅팀 (핑크색)
            4: '#FFBD33', // 회계팀 (노란색)
            5: '#3357FF'  // 영업팀 (파란색)
        };

        var departmentNames = {
            1: "인사팀",
            2: "개발팀",
            3: "마케팅팀",
            4: "회계팀",
            5: "영업팀"
        };

        // 캘린더 설정
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            fixedWeekCount: false,
            displayEventTime: false,
            events: '/event',

            // 날짜 클릭 시 일정 추가 모달
            dateClick: function(info) {
                eventTitleInput.value = '';
                eventDescriptionInput.value = '';
                eventStartDateInput.value = info.dateStr + "T09:00"; // 기본값 설정
                eventEndDateInput.value = info.dateStr + "T10:00";   // 기본값 설정

                // 클릭한 날짜를 시작 날짜로 설정
                eventStartDateInput.value = info.dateStr;  // 클릭한 날짜를 시작 날짜 필드에 적용
                eventEndDateInput.value = info.dateStr;    // 종료 날짜도 시작 날짜와 동일하게 설정 (기본값 설정)

                // 부서 기본값 설정 (기본적으로 인사팀(1번))
                var departmentCode = 1;

                saveEventBtn.onclick = saveEvent;

                deleteEventBtn.style.display = 'none';

                openModal();
            },

            // 일정 클릭 시 상세 보기 모달
            eventClick: function(info) {
                var event = info.event;
                eventTitleInput.value = event.title;
                eventDescriptionInput.value = event.extendedProps.description;
                eventStartDateInput.value = event.startStr;
                eventEndDateInput.value = event.endStr ? event.endStr.split('T')[0] : event.startStr;

                // 부서 코드에서 색상 자동 적용
                var departmentCode = event.extendedProps.departmentCode;

                console.log(departmentCode)


                saveEventBtn.onclick = function() {
                    event.setProp('title', eventTitleInput.value);
                    event.setExtendedProp('description', eventDescriptionInput.value);
                    event.setStart(eventStartDateInput.value);
                    event.setEnd(eventEndDateInput.value || null);
                    event.setExtendedProp('departmentCode', departmentCode);

                    if (eventEndDateInput.value < eventStartDateInput.value) {
                        alert('종료 날짜는 시작 날짜보다 앞설 수 없습니다.');
                        return;
                    }

                    const updatedEventData = {
                        workId: event.id,  // 수정할 일정을 구분하는 고유 ID
                        workTitle: eventTitleInput.value,  // 수정된 제목
                        workExplanation: eventDescriptionInput.value,  // 수정된 설명
                        workSchedule: eventStartDateInput.value,  // 수정된 시작 날짜
                        deadLine: eventEndDateInput.value  // 수정된 종료 날짜
                    };


                    if (confirm('이 일정을 정말로 수정하시겠습니까?')) {
                        fetch('/workModify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updatedEventData),
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert('일정이 수정되었습니다.');
                                    closeModal();
                                } else {
                                    alert('수정 실패');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }

                    closeModal();
                };

                // 삭제하기
                deleteEventBtn.onclick = function() {
                    if (confirm('이 일정을 정말로 삭제하시겠습니까?')) {
                        fetch('/workDelete', {
                            method: 'POST', // POST를 사용하여 데이터 전달
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ workId: event.id }) // `workId`를 JSON으로 보냄
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert('일정이 삭제되었습니다.');
                                    event.remove();
                                    closeModal();
                                } else {
                                    alert('삭제 실패');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }
                };

                deleteEventBtn.style.display = 'inline-block';
                openModal();
            }
        });

        calendar.render();

        // 모달 열기
        function openModal() {
            modal.style.display = 'block';
            modalOverlay.style.display = 'block';
        }

        // 모달 닫기
        function closeModal() {
            modal.style.display = 'none';
            modalOverlay.style.display = 'none';
        }

        closeModalBtn.onclick = closeModal;
        modalOverlay.onclick = closeModal;

        // 저장 일정 처리 함수
        function saveEvent() {
            var eventTitle = eventTitleInput.value;
            var eventDescription = eventDescriptionInput.value;
            var eventStartDate = eventStartDateInput.value;
            var eventEndDate = eventEndDateInput.value;

            if (eventEndDate < eventStartDate) {
                alert('종료 날짜는 시작 날짜보다 앞설 수 없습니다.');
                return;
            }

            // 부서 코드 (1번으로 기본 설정)
            var departmentCode = 1;
            var eventColor = departmentColors[departmentCode];

            if (eventTitle && eventDescription && eventStartDate && eventEndDate) {
                // JSON 형태로 데이터 준비
                var eventData = {
                    workTitle: eventTitle,
                    workExplanation: eventDescription,
                    workSchedule: eventStartDate,
                    deadLine: eventEndDate,
                    deptCode: departmentCode
                };

                // 데이터 들어왔나 확인
                console.log('Event Data:', eventData);


                closeModal();
                // 서버로 데이터 전송
                fetch('/allWork', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                })
                    .then(response => {
                        if (response.ok) {
                            alert('일정이 저장되었습니다.');
                            location.reload();
                        } else {
                            alert('저장 실패');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                closeModal();
            } else {
                alert('모든 필드를 입력해주세요.');
            }
        }
    });
</script>

</body>
</html>
