<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ohgiraffers.refactorial.mail.model.dao.MailMapper">

    <resultMap id="MailResultMap" type="com.ohgiraffers.refactorial.mail.model.dto.MailDTO">
        <id property="emailId" column="email_id"/>
        <result property="emailTitle" column="email_title"/>
        <result property="emailContent" column="email_content"/>
        <result property="sentDate" column="sent_date"/>
        <result property="trashStatus" column="trash_status"/>
        <result property="senderEmpId" column="sender_emp_id"/>
    </resultMap>

    <resultMap id="MailReceiverResultMap" type="com.ohgiraffers.refactorial.mail.model.dto.MailReceiverDTO">
        <id property="id" column="id"/>
        <result property="emailId" column="email_id"/>
        <result property="receiverEmpId" column="receiver_emp_id"/>
        <result property="readStatus" column="read_status"/>
    </resultMap>

    <!-- 메일 보내기 -->
    <insert id="sendMail" parameterType="com.ohgiraffers.refactorial.mail.model.dto.MailDTO">
        INSERT INTO tbl_mail (email_id, email_title, email_content, sent_date, trash_status, sender_emp_id)
        VALUES (#{emailId}, #{emailTitle}, #{emailContent}, CURDATE(), 0 , #{senderEmpId})
    </insert>
    <insert id="saveReceiver" parameterType="com.ohgiraffers.refactorial.mail.model.dto.MailReceiverDTO">
        INSERT INTO tbl_mail_receivers (email_id, receiver_emp_id, read_status)
        VALUES (#{emailId}, #{receiverEmpId}, #{readStatus})
    </insert>

    <select id="getSentMails" resultMap="MailResultMap">
        SELECT
        m.email_id,
        m.email_title,
        m.email_content,
        m.sent_date,
        m.trash_status,
        m.sender_emp_id,
        mr.receiver_emp_id
        FROM
        tbl_mail m
        JOIN
        tbl_mail_receivers mr ON m.email_id = mr.email_id
        WHERE
        m.sender_emp_id = #{senderEmpId} AND m.trash_status = 0
        ORDER BY
        m.sent_date DESC;
    </select>


    <!-- 내가 받은 메일 조회 -->
    <select id="getReceivedMails" resultMap="MailResultMap">
        SELECT
        *
        FROM tbl_mail m JOIN tbl_mail_receivers mr on m.email_id = m.email_id
        WHERE mr.receiver_emp_id = #{receiverEmpId} AND m.trash_status = 0
        ORDER BY m.sent_date DESC;
    </select>


</mapper>
