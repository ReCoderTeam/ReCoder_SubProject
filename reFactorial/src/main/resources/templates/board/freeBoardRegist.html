<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 등록</title>

    <!--폰트 적용-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/style.css}">

    <link rel="stylesheet" th:href="@{/css/board/list.css}">
    <link rel="stylesheet" th:href="@{/css/board/freeBoardRegist.css}">
    <link rel="stylesheet" href="../../static/css/board/freeBoardRegist.css">


</head>
<body>
<header th:replace="~{/common/header::headerFragment}"></header>
<section>
    <div class="container">
        <!-- Sidebar -->
        <div th:replace="~{/board/sidebar::sidebarFragment}"></div>

        <div class="form-container">
            <form id="freeBoardForm" action="/board/freeBoardRegist" method="post" enctype="multipart/form-data">

                <input type="hidden" name="postId" th:value="${postDetail != null} ? ${postDetail.postId} : ''">

                <div class="BoradRegist_topBox">

                    <!-- 등록 버튼 -->
                    <div class="button-group">
                        <button type="submit" class="submit-btn">등 록</button>
                    </div>

                    <!-- 제목 -->
                    <div class="form-group">
                        <label for="title">제목:</label>
                        <input type="text" id="title" name="title" th:value="${postDetail != null} ? ${postDetail.postTitle} : ''" required/>
                    </div>

                    <!-- 분류 -->
                    <div class="form-group">
                        <label for="categoryCode">분류:</label>
                        <select id="categoryCode" name="categoryCode" onchange="onChangeSelectOption()">
                            <option value="">선택</option>
                            <option value=1 th:selected="${categoryCode == 1}">공지사항</option>
                            <option value=2 th:selected="${categoryCode == 2}">자유게시판</option>
                            <option value=3 th:selected="${categoryCode == 3}">문서양식</option>
                            <option value=4 th:selected="${categoryCode == 4}">투표</option>
                            <option value=5 th:selected="${categoryCode == 5}">이벤트</option>
                        </select>
                    </div>

                    <!-- 첨부 파일 -->
                    <div class="form-group postFileBox">
                        <label for="title">첨부파일:</label>
                        <input type="file" id="postFileList" name="postFileList" multiple>
                    </div>

                    <!-- 내용 -->
                    <div class="form-group content">
                        <label for="content">내용:</label>
                        <textarea id="content" name="content" th:text="${postDetail != null} ? ${postDetail.postContent} : ''" required></textarea>
                    </div>
                </div>

                <!-- 투표게시판 조건부 input -->
                <div id="vote-container" class="form-group BoradRegist_footerBox">
                    <!-- 투표 내용 -->
                    <div class="poll-container">
                        <!-- 아래로 항목 추가를 위한 컨테이너 -->
                        <!-- 항목 추가 버튼 -->
                        <div class="add-option-box">
                            <button id="add-option" type="button">항목 추가</button>
                        </div>

                        <div id="poll-options" class="container">
                            <!-- 기본 항목 1과 2는 삭제 버튼을 없애고 항상 표시 -->
                            <div class="input-group-item">
                                <label for="option1">항목 1 : </label>
                                <input type="text" id="option1" name="option1" placeholder="내용을 입력하세요">
                            </div>

                            <div class="input-group-item">
                                <label for="option2">항목 2 : </label>
                                <input type="text" id="option2" name="option2" placeholder="내용을 입력하세요">
                            </div>
                        </div>
                        <p id="error-message" style="color: #2b2b2b; display: none;">최대 항목 수는 5개입니다.</p>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
<footer th:replace="~{/common/footer::footerFragment}"></footer>

<script th:inline="javascript">
    let optionCount = 2; // 기본 항목 개수
    const maxOptions = 5; // 최대 항목 수 설정
    const minOptions = 2; // 최소 항목 수 설정

    // 항목 추가 버튼 클릭 시
    document.getElementById('add-option').addEventListener('click', function () {
        const errorMessage = document.getElementById('error-message');
        const pollContainer = document.getElementById('poll-options');
        const addButton = document.getElementById('add-option');

        if (optionCount >= maxOptions) {
            errorMessage.style.display = 'block'; // 최대 항목 수 경고 메시지
            addButton.style.display = 'none'; // 버튼 숨기기
            return;
        }

        errorMessage.style.display = 'none'; // 정상 추가 시 경고 메시지 숨기기

        optionCount++;

        // 새 항목 추가
        const newOption = document.createElement('div');
        newOption.classList.add('input-group-item');
        newOption.innerHTML = `
                            <label for="option${optionCount}">항목 ${optionCount} : </label>
                            <input type="text" id="option${optionCount}" name="option${optionCount}" placeholder="내용을 입력하세요">
                            <button type="button" class="delete-option">삭제</button>`;
        pollContainer.appendChild(newOption);

        // 삭제 버튼 이벤트 추가
        newOption.querySelector('.delete-option').addEventListener('click', function () {
            // 항목 삭제 전, 최소 항목 수 체크
            if (optionCount <= minOptions) {
                alert(`최소 ${minOptions}개의 항목은 유지해야 합니다.`);
                return; // 최소 항목 수 이하로 삭제 방지
            }

            pollContainer.removeChild(newOption); // 항목 삭제
            optionCount--; // 항목 개수 감소

            // 삭제 후 항목 번호 다시 정렬
            updateOptionNumbers();

            // 최소 항목 수를 유지하도록 처리
            updateDeleteButtons();

            // "항목 추가" 버튼 다시 보이게 하기
            if (optionCount < maxOptions) {
                addButton.style.display = 'inline-block';
            }
        });

        // 최대 항목 수 도달 시 추가 버튼 숨기기
        if (optionCount >= maxOptions) {
            addButton.style.display = 'none'; // 추가 버튼 숨기기
        }

        // 삭제 버튼이 최소 항목 수가 되면 숨기기
        updateDeleteButtons();
    });

    // 초기 항목에 삭제 버튼 이벤트 추가 (항목 3부터는 삭제 버튼 추가)
    document.querySelectorAll('.delete-option').forEach(button => {
        button.addEventListener('click', function () {
            // 항목 삭제 전, 최소 항목 수 체크
            if (optionCount <= minOptions) {
                alert(`최소 ${minOptions}개의 항목은 유지해야 합니다.`);
                return; // 최소 항목 수 이하로 삭제 방지
            }

            const optionGroup = button.closest('.input-group-item');
            optionGroup.remove(); // 항목 삭제
            optionCount--; // 항목 개수 감소

            // 삭제 후 항목 번호 다시 정렬
            updateOptionNumbers();

            // 최소 항목 수를 유지할 수 있도록 버튼을 보이게 처리
            updateDeleteButtons();

            // "항목 추가" 버튼 다시 보이게 하기
            if (optionCount < maxOptions) {
                document.getElementById('add-option').style.display = 'inline-block';
            }
        });
    });

    // 삭제 후 항목 번호를 재정렬하는 함수
    function updateOptionNumbers() {
        const pollContainer = document.getElementById('poll-options');
        const options = pollContainer.querySelectorAll('.input-group-item');

        // 각 항목에 대해 번호를 다시 매김
        options.forEach((option, index) => {
            const label = option.querySelector('label');
            label.setAttribute('for', `option${index + 1}`);  // id 속성 수정
            label.innerHTML = `항목 ${index + 1} :`;  // 항목 번호 업데이트
            const input = option.querySelector('input');
            input.setAttribute('id', `option${index + 1}`);  // input id 수정
        });

        optionCount = options.length; // optionCount를 업데이트
    }

    // 삭제 버튼 표시 여부 업데이트
    function updateDeleteButtons() {
        const deleteButtons = document.querySelectorAll('.delete-option');

        // 항목이 2개 이하로 남은 경우 삭제 버튼 숨기기
        if (optionCount <= minOptions) {
            deleteButtons.forEach(button => {
                button.style.display = 'none';
            });
        } else {
            deleteButtons.forEach(button => {
                button.style.display = 'inline-block'; // 삭제 버튼 보이기
            });
        }

        // "항목 추가" 버튼 표시 여부 업데이트
        const addButton = document.getElementById('add-option');
        if (optionCount < maxOptions) {
            addButton.style.display = 'inline-block'; // 항목 추가 버튼 보이기
        } else {
            addButton.style.display = 'none'; // 항목 추가 버튼 숨기기
        }
    }

    function onChangeSelectOption(){
        const categoryCode = document.querySelector('#categoryCode').value;
        const voteContainer = document.querySelector('#vote-container');

        const postFileBox = document.querySelector(".postFileBox");
        const freeBoardForm = document.querySelector('#freeBoardForm');

        if(categoryCode === "4"){
            postFileBox.style.display = 'none';
            voteContainer.style.display = 'block';
            freeBoardForm.removeAttribute('enctype');
        }else if(categoryCode === "3"){
            postFileBox.style.display = 'block'
            voteContainer.style.display = 'none';

            // form에 enctype 속성 추가
            freeBoardForm.setAttribute('enctype', 'multipart/form-data');
        }else{
            voteContainer.style.display = 'none';
            postFileBox.style.display = 'none';
            freeBoardForm.removeAttribute('enctype');
        }
    }

    function initSelectOption(){
        const categoryCode =  /*[[${categoryCode}]]*/ 1;
        const voteContainer = document.querySelector('#vote-container');

        const postFileBox = document.querySelector(".postFileBox");
        const freeBoardForm = document.querySelector('#freeBoardForm');


        // 카테고리 코드가 4일 경우 투표항목 노출
        if(categoryCode === 4){
            postFileBox.style.display = 'none';
            voteContainer.style.display = 'block';
            freeBoardForm.removeAttribute('enctype');

        // 카테고리 코드가 3일 경우 첨부파일 노출
        }else if(categoryCode === 3){
            postFileBox.style.display = 'block'
            voteContainer.style.display = 'none';

            // form에 enctype 속성 추가
            freeBoardForm.setAttribute('enctype', 'multipart/form-data');
        }else{
            voteContainer.style.display = 'none';
            postFileBox.style.display = 'none';
            freeBoardForm.removeAttribute('enctype');
        }
    }

    // 처음 페이지 로딩 시 최소 항목 수 보장
    updateDeleteButtons();  // 삭제버튼 표시여부
    initSelectOption();     // 카테고리 3,4일 때 첨부파일,투표 표시

</script>

</body>
</html>
