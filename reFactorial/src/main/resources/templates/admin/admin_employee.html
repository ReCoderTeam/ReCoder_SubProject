<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- 공통 복사 -->
    <link rel="stylesheet" th:href="@{/css/admin/common/admin_header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/admin/common/admin_style.css}">
    <link rel="stylesheet" th:href="@{/css/admin/common/admin_circleBtn.css}">

    <link rel="stylesheet" th:href="@{/css/admin/admin_employee.css}">
    <!--등록하기 일 경우-->
    <link rel="stylesheet" th:href="@{/css/admin/addEmployee.css}">
    <link rel="stylesheet" href="../../static/css/admin/admin_employee.css">


</head>
<body>

    <header th:replace="~{/admin/common/admin_header::adminHeaderFragment}"></header>
    <section>
        <div class="leftBox">
            <div th:replace="~{admin/common/admin_circle_menu::adminCircleMenuFragment}"></div>
        </div>

        <div class="rightBox">
            <div class="sideMenu">
                <div class="sideTitle">사 원</div>

                <ul class="sideMenuUl">
                    <li id="modifyEmpInfo" class="selected">정보수정</li>
                    <li id="registeEmp">등록하기</li>
                    <li id="updateAtt">근태수정</li>
                </ul>
            </div>
            <div class="menuMainBox">

            </div>
        </div>
    </section>
    <!-- 유저 페이지들과 footer 공동 사용 -->
    <footer th:replace="~{/common/footer::footerFragment}"></footer>

    <script>
        const menuMainBox = document.querySelector(".menuMainBox");
        const selectedMenu = document.querySelectorAll(".sideMenuUl li");
        const modifyEmpInfo = document.querySelector("#modifyEmpInfo");
        const registeEmp = document.querySelector("#registeEmp");
        const updateAtt = document.querySelector("#updateAtt");

        window.onload = function (){
            fetch("/admin/getAllEmployee",{
                method:'GET',
                headers : {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {

                    let employeeList = '';

                    data.userList.forEach( employee =>{
                        employeeList += `<div class="empItem" data-emp-id = "${employee.empId}">
                                            <div class="profileImg">
<!--                                                <img src=${employee.profile} alt="사진">-->
                                                <img src="#" alt="사진">
                                            </div>

                                            <div>${employee.empName}</div>
                                            <div>${employee.empId}</div>
                                            <div class="deptPosition">
                                                <div>${employee.deptName}/</div>
                                                <div>${employee.positionName}</div>
                                            </div>
                                        </div>`
                    })

                    menuMainBox.innerHTML = `
                        <div class="employeeListBox">
                            <div class="searchBox">
                                <form action="#">
                                    <div>
                                        <label for="searchBox">사번 : </label>
                                        <input type="text" name="searchBox" id="searchBox">
                                    </div>
                                    <button type="button">조 회</button>
                                </form>
                            </div>

                            <div class="employeeList">
                                ${employeeList}  <!-- 동적으로 생성된 empItem을 삽입 -->
                            </div>
                        </div>
                    `;

                    const empItems = document.querySelectorAll(".empItem")
                    empItems.forEach(item =>{
                        item.addEventListener("click",()=>{
                            const empId = item.dataset.empId;

                            console.log("보여줄 대상자 : ",empId)

                            fetch(`/admin/modifyEmpInfo?empId=${empId}`)
                                .then(response => response.json())
                                .then(data =>{

                                    console.log("data : ",data)

                                    fetch('/admin/addEmployeeFragment',{
                                        method : 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            ModifyUser: data.ModifyUser// ModifyUser 객체를 서버로 전달
                                        }),
                                    })
                                        .then(response => response.text())
                                        .then(html =>{
                                            const form = new DOMParser().parseFromString(html, "text/html").querySelector('form');

                                            menuMainBox.innerHTML = '';
                                            menuMainBox.appendChild(form);
                                        })

                                })
                                .catch((error) => console.error("Fetch error: ", error));
                        })
                    })


                })
                .catch(error => {
                    console.error("Fetch error: ", error);
                });
        }

        // 등록하기
        registeEmp.addEventListener("click",()=>{
            fetch("/admin/addEmployeeFragment")
                .then(response => response.text())
                .then(html => {
                    // HTML에서 form 부분만 추출
                    const form = new DOMParser().parseFromString(html, "text/html").querySelector('form');

                    menuMainBox.innerHTML = '';
                    menuMainBox.appendChild(form);
                })

            selectedMenu.forEach(menu =>{
                menu.classList.remove("selected")
            })

            registeEmp.classList.add("selected")
        })

        // 정보수정 클릭
        modifyEmpInfo.addEventListener("click",()=>{
            window.location.reload();
        })

    </script>

    <script>
        // 근태 수정
        let page = 1;

        // fetchData 함수는 전역에서 사용할 수 있도록 밖으로 이동
        const fetchData = (page = 1) => {
            const selectedDay = document.getElementById('searchAttDate').value;

            fetch(`/admin/getByDateAtt?selectedDay=${encodeURIComponent(selectedDay)}&page=${page}&size=10`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log("전체 사원 근태 data: ", data);

                    // 테이블의 tbody에 데이터를 추가
                    const empAttTable = document.getElementById("empAttTable");
                    empAttTable.innerHTML = '';

                    data.items.forEach((att) => {
                        fetch('/user/getNameById', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                empId: att.empId
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                const attEmpName = data.empName;

                                const row = `
                        <tr>
                            <td class="empId">${att.empId}</td>
                            <td class="empName">${attEmpName}</td>
                            <td class="attDate">${att.attDate}</td>
                            <td class="attStatus">
                                <select name="attStatus" id="attStatus" data-emp-id="${att.empId}" data-att-date="${att.attDate}" onchange="logAttStatus(this)">
                                    <option value="지각" ${att.attStatus === '지각' ? 'selected' : ''}>지각</option>
                                    <option value="연차" ${att.attStatus === '연차' ? 'selected' : ''}>연차</option>
                                    <option value="반차" ${att.attStatus === '반차' ? 'selected' : ''}>반차</option>
                                    <option value="정상 출근" ${att.attStatus === '정상 출근' || att.attStatus === '출근' ? 'selected' : ''}>정상 출근</option>
                                </select>
                            </td>
                        </tr>
                    `;
                                empAttTable.innerHTML += row;

                                // select 요소에 change 이벤트 리스너를 추가
                                const selectElement = document.querySelector(`#attStatus[data-emp-id="${att.empId}"][data-att-date="${att.attDate}"]`);
                                selectElement.addEventListener('change', (event) => logAttStatus(event.target));
                            })
                            .catch(error => {
                                console.error("Fetch error: ", error);
                            });
                    });

                    const pagination = document.querySelector('.pagination');
                    const totalPages = data.totalPages;

                    pagination.innerHTML = '';  // 기존 페이지네이션 초기화

                    for (let i = 1; i <= totalPages; i++) {
                        const pageButton = document.createElement('button');
                        pageButton.textContent = i;
                        pageButton.addEventListener('click', () => {
                            page = i
                            fetchData(page);  // 해당 페이지 데이터 가져오기
                        });
                        pagination.appendChild(pageButton);
                    }
                })
                .catch(error => {
                    console.error("Fetch error: ", error);
                });
        };

        // logAttStatus 함수는 전역에서 호출될 수 있도록 정의
        function logAttStatus(selectElement) {
            const empId = selectElement.getAttribute('data-emp-id');
            const attDate = selectElement.getAttribute('data-att-date');
            const selectedStatus = selectElement.value;

            fetch('/admin/modifyEmpAtt',{
                method:'POST',
                headers : {
                    'Content-Type': 'application/json',
                },
                body : JSON.stringify({
                    empId: empId,
                    attDate: attDate,
                    selectedStatus: selectedStatus
                })
            })
                .then(response => response.json())
                .then(data =>{
                    // 근태 상태가 변경된 후 데이터를 새로 고침
                    // fetch(page)
                })
        }

        // updateAtt 버튼 클릭 시 이벤트
        updateAtt.addEventListener("click", () => {
            menuMainBox.innerHTML = `
            <div class="allEmpAttListBox">
                <div class="searchAttBox">
                    <form>
                        <div class="searchAttIdBox">
                            <label for="searchAttId">사번</label>
                            <input type="text" id="searchAttId" name="searchAttId">
                            <button type="button">조회</button>
                        </div>
                        <input type="date" id="searchAttDate" name="searchAttDate">
                    </form>
                </div>
                <div class="empAttList">
                    <div class="empAttListTitle">
                        <table>
                            <tr>
                                <th class="empId">사번</th>
                                <th class="empName">이름</th>
                                <th class="attDate">날짜</th>
                                <th class="attStatus">근태 상태</th>
                            </tr>
                        </table>
                    </div>
                    <div class="empAttListContent">
                        <table id="empAttTable"></table>
                    </div>
                </div>
                <div class="pagination"></div>
            </div>
        `;

            // 오늘 날짜를 가져와서 기본값으로 설정
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('searchAttDate').value = formattedDate;

            const searchAttDateInput = document.getElementById('searchAttDate');

            // 처음 데이터 로드
            fetchData(1);
            page=1;

            // 날짜가 변경될 때마다 데이터 새로고침
            searchAttDateInput.addEventListener('change', () => {
                fetchData(1);
                page=1
            });

            selectedMenu.forEach(menu =>{
                menu.classList.remove("selected")
            })

            updateAtt.classList.add("selected")
        });
    </script>



</body>
</html>