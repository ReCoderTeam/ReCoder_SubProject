<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시물 상세</title>

    <!--폰트 적용-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/style.css}">

    <link rel="stylesheet" th:href="@{/css/board/postDetail.css}">
    <link rel="stylesheet" href="../../static/css/board/postDetail.css">
    <link rel="stylesheet" th:href="@{/css/board/list.css}">

</head>
<body>
<header th:replace="~{/common/header::headerFragment}"></header>
<section>
    <div class="boardContainer">
        <!-- Sidebar -->
        <div th:replace="~{/board/sidebar::sidebarFragment}"></div>

        <div class="rightBoxContainer">
        <!-- 로그인한 사용자와 작성자 ID비교(본인만 수정,삭제 권한부여) -->
            <div class="top-bar button">
                <th:block th:if="${user.empId} == ${postDetail.empId}">

                    <!-- 상세페이지 게시물 수정 -->
                    <form action="/board/postUpdate" method="get">
                        <!-- 게시물 ID 전달 -->
                        <input type="hidden" name="postId" th:value="${postDetail.postId}">
                        <button type="submit" style="display: block; margin-top: 20px;">수 정</button>
                    </form>

                    <!-- 상세페이지 게시물 삭제 -->
                    <form action="/board/postDelete" method="post">
                        <input type="hidden" name="postId" th:value="${postDetail.postId}">
                        <input type="hidden" name="categoryCode" th:value="${postDetail.categoryCode}">
                        <button type="submit" style="display: block; margin-top: 20px;">삭 제</button>
                    </form>
                </th:block>
            </div>

        <!-- 상세페이지 -->
            <div class="boardDetail">
                <!-- 게시물 상세 제목 -->
                <h1 th:text="${postDetail.postTitle}">게시물 제목</h1>

                <!-- 작성자 정보 -->
                <p><strong>작성자:</strong> <span th:text="${postDetail.empName}">작성자</span></p>

                <!-- 작성 날짜 -->
                <p><strong>작성일:</strong> <span th:text="${postDetail.postCreationDate}">작성일</span></p>

                <!-- 게시물 내용 -->
                <p><strong>내용:</strong></p>
                <div th:text="${postDetail.postContent}">
                    게시물 내용이 여기에 표시됩니다.
                </div>

                <br>
                <hr>

                <!-- 투표 항목 조회 / DB에 전송 -->
                <form action="/board/vote" method="post" th:if="${currentCategory == 4}">
                    <div>
                        <div th:each="vote :${voteView}">
                            <input type="checkbox" name="voteIdList[]" th:value="${vote.itemId}"/>
                            <label th:for="${vote.itemTitle}" th:text="${vote.itemTitle}"></label>
                            <hr>
                        </div>
                        <button type="submit">투표하기</button>
                    </div>
                    <input type="hidden" name="categoryCode" th:value="${currentCategory}"/>
                    <input type="hidden" name="postId" th:value="${postDetail.postId}"/>
                    <input type="hidden" name="voteResults" th:value="${voteSelectResult}"/>
                    <input type="hidden" name="voteSelectResult" th:value="${voteSelectResult}"/>

                </form>

                <!-- 사용자가 선택한 투표 결과를 표시 -->
<!--                <div th:if="${voteResults != null}">-->
<!--                    <h3>사용자가 선택한 투표 결과</h3>-->
<!--                    <ul>-->
<!--                        <li th:each="result : ${voteResults}" th:text="${voteResults.itemId}"></li>-->
<!--                    </ul>-->
<!--                </div>-->


                <!-- 선택한 투표 결과 조회 -->
<!--                <form action="/board/vote" method="post" th:if="${currentCategory == 4  || voteResults != null}">-->
<!--                    <div>-->
<!--                        <div th:each="vote :${voteResults}">-->
<!--                            <input type="checkbox" name="voteIdList[]" th:value="${vote.empId}"/>-->
<!--                            <label th:for="${vote.itemId}" th:text="${vote.itemId}"></label>-->
<!--                            <hr>-->
<!--                        </div>-->
<!--                        <input type="hidden" name="postId" th:value="${postId}" />-->
<!--                        <input type="hidden" name="categoryCode" th:value="${currentCategory}" />-->
<!--                    </div>-->
<!--                </form>-->

                <!-- 목록으로 돌아가기 -->
                <a th:href="@{/board/list(categoryCode=${postDetail.categoryCode})}"
                   style="display: block; margin-top: 20px;">목록으로 돌아가기</a>


                <!-- 댓글 등록-->
                <form action="/board/comment" method="post">
                    <p>댓글</p>
                    <textarea id="comment" name="comment"></textarea>
                    <!-- 게시글 ID를 숨겨서 전달 -->
                    <input type="hidden" name="postId" th:value="${postDetail.postId}">
                    <input type="hidden" name="categoryCode" th:value="${postDetail.categoryCode}">
                    <button type="submit">등 록</button>
                    <hr>
                    <div th:if="${comment != null}">
                        <span th:text="${comment}">댓글 내용이 여기에 표시됩니다.</span>
                    </div>
                </form>

                <!-- 댓글 조회 -->
                <div id="comment-list">
                    <div th:each="comment : ${commentView}"
                         style="display: flex; border-bottom: 1px solid gray; padding: 10px;">
                        <div style="width: 35%;" th:text="${comment.empName}">등록자</div>
                        <div style="width: 30%;" th:text="${comment.commentContent}">댓글 내용</div>
                        <div style="width: 30%;" th:text="${comment.commentCreationDate}">날짜</div>

                        <!-- 댓글 삭제 버튼 -->
                        <th:block th:if="${user.empId} == ${comment.empId}">
                            <button type="button" data-toggle="modal" data-target="#commentDeleteModal"
                                    th:data-comment-id="${comment.commentId}"
                                    th:data-post-id="${comment.postId}" class="deleteBtn">삭제
                            </button>
                        </th:block>

                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
<input type="hidden" id="empId" th:value="${user.empId}">


<!-- 댓글 삭제 모달 -->
<footer th:replace="~{/common/footer::footerFragment}"></footer>

<div class="modal fade" id="commentDeleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">
<!--                            <img src="../../static/images/close.svg" alt="닫기 버튼">-->
                            <img src="/images/close.svg" alt="닫기 버튼">
                        </span>
                </button>
                <div>삭제 하시겠습니까?</div>
            </div>
            <form action="#" method="post" id="changePWForm">
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" id="confirmDeleteBtn" data-dismiss="modal">확 인</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취 소</button>
                </div>
            </form>
        </div>
    </div>
</div>






<script>
    // 댓글 삭제 버튼 클릭 시 동작 (addEventListener 클릭시 동작을 하는 것)
    // 삭제버튼 눌렀을 때 data-comment-id와 data-post-id 세팅하는 이벤트
    document.querySelector('#comment-list').addEventListener('click', function (event) {
        // 클릭한 요소가 .deleteBtn인지 확인
        if (event.target && event.target.classList.contains('deleteBtn')) {
            const commentId = event.target.getAttribute('data-comment-id');
            const postId = event.target.getAttribute('data-post-id');

            const confirmDeleteBtn = document.querySelector("#confirmDeleteBtn");

            // 모달의 확인 버튼에 삭제할 댓글 ID와 게시글 ID 설정
            confirmDeleteBtn.setAttribute('data-comment-id', commentId);
            confirmDeleteBtn.setAttribute('data-post-id', postId);

            console.log('모달에 설정된 commentId:', commentId);
            console.log('모달에 설정된 postId:', postId);
        }
    });

    // 확인 버튼
    const confirmDeleteBtn = document.querySelector("#confirmDeleteBtn");
    // 확인 버튼 누를 시 댓글 삭제 API 호출 후 댓글 리랜더링
    confirmDeleteBtn.addEventListener("click", function () {
        const commentId = confirmDeleteBtn.getAttribute('data-comment-id');
        const postId = confirmDeleteBtn.getAttribute('data-post-id');

        console.log("삭제 요청: commentId:", commentId, "postId:", postId);

        // 서버로 삭제 요청
        fetch(`http://localhost:8080/board/commentDelete?commentId=${commentId}&postId=${postId}`)
            .then((response) => response.json())
            .then((data) => {
                console.log("삭제 후 데이터:", data);

                const commentListArea = document.querySelector('#comment-list');
                let commentList = '';
                let empId = document.querySelector('#empId').value;

                // 새로운 댓글 리스트를 생성
                data.forEach((item) => {
                    commentList += `
                    <div style="display: flex; border-bottom: 1px solid gray; padding: 10px;">
                        <div style='width: 35%;'>${item.empName}</div>
                        <div style='width: 30%;'>${item.commentContent}</div>
                        <div style='width: 30%;'>${item.commentCreationDate}</div>
                    `
                    if(empId === item.empId) {
                        commentList += `
                        <button type="button" data-toggle="modal" data-target="#commentDeleteModal"
                        data-comment-id="${item.commentId}"
                        data-post-id="${item.postId}"
                        class="deleteBtn">삭제</button>
                        `
                    }
    commentList += `</div>`;
                });

                // 댓글 리스트 업데이트
                // innerHTML : 이 요소 안에 HTML을 넣겠습니다.
                commentListArea.innerHTML = commentList;
            });
    });

</script>

<!--boostrap-->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<!--boostrap-->

</body>
