<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>My Page</title>

    <!--폰트 적용-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/style.css}">
    <!--여기까지 공동 복사-->

    <!-- fullCalender -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.css">

    <link rel="stylesheet" th:href="@{/css/myPage/myPage.css}">
    <link rel="stylesheet" href="../../static/css/myPage/myPage.css">

</head>
<body>
    <header th:replace="~{/common/header::headerFragment}"></header>
    <section>
        <div class="myPageSection">
            <div class="pageTitle">마이페이지</div>

            <div class="sectionBox">
                <div class="topBox">
    <!--이미지 박스-->
                    <div class="profileImg">
                        <img src="../images/loopy.jpg">
    <!--                    <img src="../../static/images/loopy.jpg">-->
                    </div>
    <!--개인 정보-->
                    <div class="personal_Info">
                        <div class="InfoLine">
                            <div>
                                <p>이름 :</p>
                                <p th:text="${LoginUserInfo != null? LoginUserInfo.empName : null}"></p>
                            </div>
                            <div>
                                <p>사번 :</p>
                                <p th:text="${LoginUserInfo != null? LoginUserInfo.empId : null}"></p>
                            </div>
                            <div>
                                <p>입사일 :</p>
                                <p th:text="${LoginUserInfo != null? LoginUserInfo.empJoined : null}"></p>
                            </div>
                            <div>
                                <button class="personal_InfoBtn">
                                    <img src="../images/updateIcon.svg">
                                </button>
                            </div>
                        </div>
                        <div class="InfoLine">
                            <div>
                                <p>부서 :</p>
                                <p th:text="${deptName}"></p>
                            </div>

                            <div>
                                <p>직책 :</p>
                                <p th:text="${positionName}"></p>
                            </div>
                        </div>
                        <div class="InfoLine">
                            <div>
                                <p>이메일 :</p>
                                <input id="email" class="modifyInfo" th:value="${LoginUserInfo != null? LoginUserInfo.empEmail : null}" disabled>
<!--                                <input id="email" class="modifyInfo" value="010-1111-1111" disabled>-->
                            </div>
                            <div>
                                <p>전화번호 :</p>
                                <input id="phone" class="modifyInfo" th:value="${LoginUserInfo != null? LoginUserInfo.empPhone : null}" disabled>
<!--                                <input id="phone" class="modifyInfo" value="010-1111-1111" disabled>-->
                            </div>
                        </div>
                        <div class="InfoLine">
                            <div>
                                <p>주소 :</p>
                                <textarea id="address" class="modifyInfo address" th:text="${LoginUserInfo != null? LoginUserInfo.empAddress : null}" disabled></textarea>
<!--                                <textarea id="address" class="modifyInfo address" disabled>서울시 강북구 인수봉로 76길 4-6 202호</textarea>-->
                            </div>
                            <div class="personal_InfoBtnBox">
                                <p>비밀번호</p>
                                <button type="button" class="personal_InfoBtn" data-toggle="modal" data-target="#passwordChangeModal">변경하기</button>
                            </div>
                            <div class="modifyInfoSave">
                                <button type="button">저장하기</button>
                            </div>
                        </div>
    <!--                        <p th:text="${LoginUserInfo != null?: 'User information is not available'}"></p>-->
                    </div>
                </div>
                <div class="underBox">
    <!--개인 근태-->
                    <div class="personalCalender">
                        <!--캘린더-->
                        <div id='calendar'></div>
                    </div>
    <!--연차 사용-->
                    <div class="personalVacation">
                        <div>사용 연차</div>
                        <div>남은 연차</div>
                        <div>근무 일수</div>
                    </div>

                </div>
            </div>
        </div>
    </section>
    <footer th:replace="~{/common/footer::footerFragment}"></footer>

    <div class="modal fade" id="passwordChangeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">
<!--                            <img src="../../static/images/close.svg" alt="닫기 버튼">-->
                            <img src="/images/close.svg" alt="닫기 버튼">
                        </span>
                    </button>
                    <div>비밀번호 변경</div>
                </div>
                <form action="changePW" method="post" id="changePWForm">
                    <div class="modal-body">
                        <label for="presentPW">현재 비밀번호</label>
                        <input type="text" id="presentPW" name="presentPW">
                        <p>현재 비밀번호와 일치하지 않습니다.</p>
                        <label for="changePW">변경 비밀번호</label>
                        <input type="text" id="changePW" name="changePW">
                        <p>비밀번호가 일치하지 않습니다.</p>
                        <label for="comparePW">비밀번호 확인</label>
                        <input type="text" id="comparePW" name="comparePW">
                        <p>비밀번호가 일치하지 않습니다.</p>
                    </div>
                    <div class="modal-footer">
<!--                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->
                        <button type="submit" id="matchPW">변 경</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!--boostrap-->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!--boostrap-->

    <!--fullCalender-->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.js"></script>

    <script>
        const currentEmail = '[[${LoginUserInfo.empEmail}]]';
        const currentPhone = '[[${LoginUserInfo.empPhone}]]';
        const currentAddress = '[[${LoginUserInfo.empAddress}]]';

        console.log("currentEmail : ", currentEmail)
        console.log("currentPhone : ", currentPhone)
        console.log("currentAddress : ", currentAddress)
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentMonth; // currentMonth 변수 선언
            let currentStart;
            var calendarEl = document.getElementById('calendar');

            function addNewEvent(title, startDate, color) {
                calendar.addEvent({
                    title: title,
                    start: startDate,
                    backgroundColor: color,
                    textColor: 'white'
                });
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {

                initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
                headerToolbar: { // 헤더에 표시할 툴 바
                    left: 'prev',
                    center: 'title',
                    right: 'next today'
                },
                titleFormat: function(date) {
                    return date.date.year + '년 ' + (parseInt(date.date.month) + 1) + '월';
                },
                selectable: false, // 달력 일자 드래그 설정가능
                locale: 'ko', // 한국어 설정
                fixedWeekCount: false,
                events: [
                    {
                        title: "지각",
                        start: '2024-12-22',
                        display : 'block',
                        backgroundColor : '#a7c957',
                        textColor:'white',
                    },
                    {
                        title: '출근',
                        start: '2024-12-23',
                        display : 'block',
                        backgroundColor : 'blue',
                        textColor:'white'
                    }
                ]
            });

            // 초기 currentMonth 값 설정
            var initialDate = calendar.getDate(); // 캘린더 초기 날짜 가져오기
            currentMonth = initialDate.getMonth() + 1; // 초기 월 설정

            // datesSet 이벤트로 currentMonth 업데이트 및 출력
            calendar.on('datesSet', function(info) {
                // 새로운 currentMonth 계산
                currentMonth = info.start.getMonth() + 1; // getMonth()는 0부터 시작하므로 +1
                currentStart = info.start;
                console.log("달력 시작 데이터:", currentStart);

                // 서버로 currentMonth 보내기
                fetch('/attendance/getattendance',{
                    method : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentStart : currentStart
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("근태 리스트 data: ", data)

                        // 모든 이벤트를 삭제하는 방법
                        calendar.getEvents().forEach(event => event.remove());

                        console.log("기존 이벤트 제거 완료");

                        data.forEach(data =>{
                            let backgroundColor = data.attStatus === "지각" ? '#ff7b00' :
                                                data.attStatus === "연차" ? "#3c73aa" :
                                                data.attStatus === "반차" ? "#77b6ea" : "#a7c957";


                            addNewEvent(data.attStatus,data.attDate,backgroundColor);
                        })

                    })
                    .catch(error => console.error("데이터 요청 실패:", error));
            });

            calendar.render();
        });


    </script>

    <script th:src="@{/js/myPage/myPage.js}"></script>


</body>
</html>